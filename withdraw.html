<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Withdraw - VORTEXA ID</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-bg: #000000;
            --secondary-bg: #0a1931;
            --accent-bg: #1a237e;
            --primary-action: #00e5ff;
            --primary-hover: #00b8d4;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --text-disabled: #757575;
            --success: #4caf50;
            --warning: #ff9800;
            --error: #f44336;
            --card-bg: rgba(10, 25, 49, 0.7);
            --border-color: rgba(0, 229, 255, 0.2);
            --modal-overlay: rgba(0, 0, 0, 0.8);
            --font-primary: 'Inter', -apple-system, sans-serif;
            --font-secondary: 'Space Grotesk', monospace;
        }

        body {
            font-family: var(--font-primary);
            background-color: var(--primary-bg);
            color: var(--text-primary);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
            animation: pageLoad 0.5s ease;
        }

        /* Background Animation */
        #space-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }

        .star {
            position: absolute;
            background-color: #ffffff;
            border-radius: 50%;
            animation: twinkle 3s infinite ease-in-out;
        }

        .star:nth-child(2n) {
            animation-delay: 1s;
        }

        .star:nth-child(3n) {
            animation-delay: 2s;
        }

        /* Header & Navigation */
        .header {
            background-color: rgba(10, 25, 49, 0.9);
            backdrop-filter: blur(10px);
            padding: 16px;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .nav-back {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: var(--primary-action);
            font-size: 14px;
            font-weight: 500;
            transition: color 0.2s ease;
        }

        .nav-back:hover {
            color: var(--primary-hover);
        }

        .logo {
            font-family: var(--font-secondary);
            font-size: 18px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-action), #2979ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 1px;
        }

        /* Main Content */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px 16px;
        }

        @media (min-width: 768px) {
            .container {
                padding: 30px 24px;
            }
        }

        @media (min-width: 1024px) {
            .container {
                padding: 40px 32px;
            }
        }

        .page-title {
            font-size: 2rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--primary-action), #2979ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        @media (min-width: 768px) {
            .page-title {
                font-size: 2.25rem;
            }
        }

        .page-subtitle {
            color: var(--text-secondary);
            margin-bottom: 30px;
            font-size: 1rem;
        }

        /* Balance Card */
        .balance-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .balance-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 229, 255, 0.3);
        }

        .balance-label {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .balance-amount {
            font-size: 2.5rem;
            font-weight: 700;
            font-family: var(--font-secondary);
            color: var(--primary-action);
        }

        /* Form Card */
        .form-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 14px 16px;
            color: var(--text-primary);
            font-size: 16px;
            font-family: var(--font-primary);
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-action);
            box-shadow: 0 0 0 2px rgba(0, 229, 255, 0.2);
        }

        .form-input.invalid {
            border-color: var(--error);
            background: rgba(244, 67, 54, 0.1);
        }

        .form-input.valid {
            border-color: var(--success);
            background: rgba(76, 175, 80, 0.1);
        }

        .form-select {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 14px 16px;
            color: var(--text-primary);
            font-size: 16px;
            font-family: var(--font-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 20px;
        }

        .form-select:focus {
            outline: none;
            border-color: var(--primary-action);
            box-shadow: 0 0 0 2px rgba(0, 229, 255, 0.2);
        }

        .error-message {
            color: var(--error);
            font-size: 13px;
            margin-top: 5px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .validation-rules {
            color: var(--text-secondary);
            font-size: 13px;
            margin-top: 5px;
        }

        /* Quick Amount Buttons */
        .quick-amounts {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        @media (min-width: 768px) {
            .quick-amounts {
                grid-template-columns: repeat(6, 1fr);
            }
        }

        .amount-btn {
            background: rgba(0, 229, 255, 0.1);
            border: 1px solid rgba(0, 229, 255, 0.3);
            border-radius: 8px;
            padding: 10px;
            color: var(--primary-action);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .amount-btn:hover {
            background: rgba(0, 229, 255, 0.2);
        }

        .amount-btn.active {
            background: var(--primary-action);
            color: #000000;
            font-weight: 600;
        }

        /* Submit Button */
        .submit-btn {
            width: 100%;
            background: linear-gradient(135deg, var(--primary-action), #2979ff);
            color: #000000;
            border: none;
            border-radius: 8px;
            padding: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            margin-top: 10px;
            font-family: var(--font-primary);
        }

        .submit-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 25px rgba(0, 229, 255, 0.9);
        }

        .submit-btn:active {
            transform: scale(0.98);
        }

        .submit-btn:disabled {
            background: #424242;
            color: var(--text-disabled);
            border: 2px solid #616161;
            cursor: not-allowed;
            opacity: 0.7;
            transform: none;
            box-shadow: none;
        }

        /* Info Card */
        .info-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .info-title {
            color: var(--primary-action);
            font-size: 18px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-list {
            list-style: none;
        }

        .info-item {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-item i {
            color: var(--primary-action);
            min-width: 16px;
        }

        /* Footer */
        .footer {
            background-color: rgba(10, 25, 49, 0.9);
            border-top: 1px solid var(--border-color);
            padding: 20px 16px;
            text-align: center;
            margin-top: 40px;
        }

        .footer-logo {
            font-family: var(--font-secondary);
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-action), #2979ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .footer-text {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 5px;
        }

        /* Loading Spinner */
        .loading-spinner {
            display: none;
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0, 229, 255, 0.3);
            border-top-color: var(--primary-action);
            border-radius: 50%;
            animation: rotate 1s linear infinite;
            margin: 20px auto;
        }

        .loading-spinner.show {
            display: block;
        }

        /* Notification Toast */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px 20px;
            color: var(--text-primary);
            font-size: 14px;
            display: none;
            align-items: center;
            gap: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            transform: translateX(100%);
            animation: slideIn 0.3s ease forwards;
            max-width: 400px;
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.error {
            border-left: 4px solid var(--error);
        }

        .toast.warning {
            border-left: 4px solid var(--warning);
        }

        .toast-icon {
            font-size: 20px;
        }

        .toast.success .toast-icon {
            color: var(--success);
        }

        .toast.error .toast-icon {
            color: var(--error);
        }

        .toast.warning .toast-icon {
            color: var(--warning);
        }

        /* Animations */
        @keyframes pageLoad {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes twinkle {
            0%, 100% {
                opacity: 0.3;
            }
            50% {
                opacity: 1;
            }
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes slideIn {
            to {
                transform: translateX(0);
            }
        }
    </style>
</head>
<body>
    <!-- Background Animation -->
    <div id="space-bg"></div>

    <!-- Header -->
    <header class="header">
        <a href="dashboard.html" class="nav-back">
            <i class="fas fa-arrow-left"></i>
            <span>Kembali</span>
        </a>
        <div class="logo">VORTEXA ID</div>
    </header>

    <!-- Main Content -->
    <main class="container">
        <h1 class="page-title">Withdraw</h1>
        <p class="page-subtitle">Ajukan penarikan saldo Anda</p>

        <!-- Balance Card -->
        <div class="balance-card">
            <div class="balance-label">
                <i class="fas fa-wallet"></i>
                Saldo Tersedia
            </div>
            <div class="balance-amount" id="balanceAmount">Rp 0</div>
        </div>

        <!-- Form Card -->
        <div class="form-card">
            <div class="form-group">
                <label class="form-label">Nominal Withdraw</label>
                <input 
                    type="number" 
                    class="form-input" 
                    id="amountInput" 
                    placeholder="Contoh: 30000"
                    min="30000"
                    step="1000"
                >
                <div class="error-message" id="amountError"></div>
                <div class="validation-rules">
                    Minimum withdraw: Rp 30.000 | Harus kelipatan 1.000
                </div>
            </div>

            <!-- Quick Amount Buttons -->
            <div class="quick-amounts">
                <button class="amount-btn" data-amount="30000">Rp 30k</button>
                <button class="amount-btn" data-amount="50000">Rp 50K</button>
                <button class="amount-btn" data-amount="100000">Rp 100k</button>
                <button class="amount-btn" data-amount="200000">Rp 200K</button>
                <button class="amount-btn" data-amount="500000">Rp 500k</button>
                <button class="amount-btn" data-amount="1000000">Rp 1JT</button>
            </div>

            <div class="form-group">
                <label class="form-label">Metode Withdraw</label>
                <select class="form-select" id="methodSelect">
                    <option value="" disabled selected>Pilih metode</option>
                    <option value="bank">Bank Transfer</option>
                    <option value="ewallet">E-Wallet</option>
                </select>
                <div class="error-message" id="methodError"></div>
            </div>

            <div class="form-group">
                <label class="form-label" id="destinationLabel">Nama Bank</label>
                <input 
                    type="text" 
                    class="form-input" 
                    id="destinationInput" 
                    placeholder="Contoh: BCA, BRI, Mandiri"
                >
                <div class="error-message" id="destinationError"></div>
            </div>

            <div class="form-group">
                <label class="form-label" id="accountLabel">Nomor Rekening</label>
                <input 
                    type="text" 
                    class="form-input" 
                    id="accountInput" 
                    placeholder="Contoh: 1234567890"
                >
                <div class="error-message" id="accountError"></div>
            </div>

            <button class="submit-btn" id="submitBtn" disabled>
                Ajukan Withdraw
            </button>

            <!-- Loading Spinner -->
            <div class="loading-spinner" id="loadingSpinner"></div>
        </div>

        <!-- Info Card -->
        <div class="info-card">
            <h3 class="info-title">
                <i class="fas fa-info-circle"></i>
                Informasi Penting
            </h3>
            <ul class="info-list">
                <li class="info-item">
                    <i class="fas fa-clock"></i>
                    Proses: 1-24 jam kerja (Senin-Jumat 09:00-17:00)
                </li>
                <li class="info-item">
                    <i class="fas fa-money-bill-wave"></i>
                    Biaya admin: Rp 0
                </li>
                <li class="info-item">
                    <i class="fas fa-calendar-alt"></i>
                    Batas penarikan: 3x per hari (Regular)
                </li>
                <li class="info-item">
                    <i class="fas fa-user-check"></i>
                    Email harus terverifikasi untuk melakukan withdraw
                </li>
                <li class="info-item">
                    <i class="fas fa-shopping-cart"></i>
                    Harus memiliki minimal 1 produk aktif
                </li>
                <li class="info-item">
                    <i class="fas fa-hand-holding-usd"></i>
                    Harus pernah melakukan deposit minimal 1x
                </li>
            </ul>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-logo">VORTEXA ID</div>
        <p class="footer-text">Platform Investasi Digital Terpercaya</p>
        <p class="footer-text">Â© 2026 VORTEXA ID. All rights reserved.</p>
    </footer>

    <!-- Notification Toast -->
    <div class="toast" id="toast">
        <i class="fas toast-icon" id="toastIcon"></i>
        <span id="toastMessage"></span>
    </div>

    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            updateDoc, 
            Timestamp, 
            increment,
            collection,
            query,
            where,
            getDocs,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAEM8RddVyDgzeveu4ZV_5mnXpOf52EoP4",
            authDomain: "vortexaind.firebaseapp.com",
            projectId: "vortexaind",
            storageBucket: "vortexaind.firebasestorage.app",
            messagingSenderId: "94487454118",
            appId: "1:94487454118:web:2469612cf7082fb8ce2f67"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // DOM Elements
        const balanceAmount = document.getElementById('balanceAmount');
        const amountInput = document.getElementById('amountInput');
        const methodSelect = document.getElementById('methodSelect');
        const destinationInput = document.getElementById('destinationInput');
        const accountInput = document.getElementById('accountInput');
        const submitBtn = document.getElementById('submitBtn');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');
        const toastIcon = document.getElementById('toastIcon');
        
        // Error message elements
        const amountError = document.getElementById('amountError');
        const methodError = document.getElementById('methodError');
        const destinationError = document.getElementById('destinationError');
        const accountError = document.getElementById('accountError');
        
        // Quick amount buttons
        const amountButtons = document.querySelectorAll('.amount-btn');
        const destinationLabel = document.getElementById('destinationLabel');
        const accountLabel = document.getElementById('accountLabel');

        // Global Variables
        let currentUser = null;
        let userData = null;
        let currentBalance = 0;
        let systemMaintenance = false;
        let hasDepositHistory = false;

        // Initialize stars background
        function initStars() {
            const spaceBg = document.getElementById('space-bg');
            const starCount = Math.floor(Math.random() * 50) + 100; // 100-150 stars
            
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                
                // Random position
                const left = Math.random() * 100;
                const top = Math.random() * 100;
                
                // Random size (1-5px)
                const size = Math.floor(Math.random() * 5) + 1;
                
                // Random color
                const colors = ['#ffffff', '#e0f7fa', '#fff9c4'];
                const color = colors[Math.floor(Math.random() * colors.length)];
                
                // Random opacity
                const opacity = Math.random() * 0.7 + 0.3;
                
                // Apply styles
                star.style.left = `${left}%`;
                star.style.top = `${top}%`;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.style.backgroundColor = color;
                star.style.opacity = opacity;
                
                // Random animation delay
                star.style.animationDelay = `${Math.random() * 3}s`;
                
                spaceBg.appendChild(star);
            }
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            toast.className = `toast ${type}`;
            toastMessage.textContent = message;
            
            switch(type) {
                case 'success':
                    toastIcon.className = 'fas fa-check-circle toast-icon';
                    break;
                case 'error':
                    toastIcon.className = 'fas fa-exclamation-circle toast-icon';
                    break;
                case 'warning':
                    toastIcon.className = 'fas fa-exclamation-triangle toast-icon';
                    break;
            }
            
            toast.style.display = 'flex';
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                toast.style.display = 'none';
            }, 5000);
        }

        // Format currency to Indonesian Rupiah
        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // Validate amount input
        function validateAmount(amount) {
            const minAmount = 30000; // Minimum withdraw from rules
            const maxAmount = currentBalance;
            
            amountError.textContent = '';
            amountError.classList.remove('show');
            amountInput.classList.remove('invalid', 'valid');
            
            if (!amount) {
                amountInput.classList.add('invalid');
                amountError.textContent = 'Nominal wajib diisi';
                amountError.classList.add('show');
                return false;
            }
            
            if (amount < minAmount) {
                amountInput.classList.add('invalid');
                amountError.textContent = `Minimum withdraw adalah Rp ${minAmount.toLocaleString('id-ID')}`;
                amountError.classList.add('show');
                return false;
            }
            
            if (amount > maxAmount) {
                amountInput.classList.add('invalid');
                amountError.textContent = 'Saldo tidak mencukupi';
                amountError.classList.add('show');
                return false;
            }
            
            if (amount % 1000 !== 0) {
                amountInput.classList.add('invalid');
                amountError.textContent = 'Nominal harus kelipatan 1.000';
                amountError.classList.add('show');
                return false;
            }
            
            amountInput.classList.add('valid');
            return true;
        }

        // Validate method selection
        function validateMethod(method) {
            methodError.textContent = '';
            methodError.classList.remove('show');
            methodSelect.classList.remove('invalid', 'valid');
            
            if (!method) {
                methodSelect.classList.add('invalid');
                methodError.textContent = 'Metode withdraw wajib dipilih';
                methodError.classList.add('show');
                return false;
            }
            
            methodSelect.classList.add('valid');
            return true;
        }

        // Validate destination input
        function validateDestination(destination) {
            destinationError.textContent = '';
            destinationError.classList.remove('show');
            destinationInput.classList.remove('invalid', 'valid');
            
            if (!destination || destination.trim().length < 2) {
                destinationInput.classList.add('invalid');
                destinationError.textContent = methodSelect.value === 'bank' 
                    ? 'Nama bank wajib diisi' 
                    : 'Nama e-wallet wajib diisi';
                destinationError.classList.add('show');
                return false;
            }
            
            destinationInput.classList.add('valid');
            return true;
        }

        // Validate account input
        function validateAccount(account) {
            accountError.textContent = '';
            accountError.classList.remove('show');
            accountInput.classList.remove('invalid', 'valid');
            
            if (!account || account.trim().length < 5) {
                accountInput.classList.add('invalid');
                accountError.textContent = methodSelect.value === 'bank'
                    ? 'Nomor rekening wajib diisi (min 5 digit)'
                    : 'Nomor akun wajib diisi (min 5 digit)';
                accountError.classList.add('show');
                return false;
            }
            
            accountInput.classList.add('valid');
            return true;
        }

        // Update form validation
        function updateFormValidation() {
            const amount = parseFloat(amountInput.value) || 0;
            const method = methodSelect.value;
            const destination = destinationInput.value.trim();
            const account = accountInput.value.trim();
            
            const isAmountValid = validateAmount(amount);
            const isMethodValid = validateMethod(method);
            const isDestinationValid = validateDestination(destination);
            const isAccountValid = validateAccount(account);
            
            submitBtn.disabled = !(isAmountValid && isMethodValid && isDestinationValid && isAccountValid);
        }

        // Check system maintenance
        async function checkMaintenance() {
            try {
                const configRef = doc(db, 'config', 'system');
                const configSnap = await getDoc(configRef);
                
                if (configSnap.exists()) {
                    const configData = configSnap.data();
                    systemMaintenance = configData.maintenance || false;
                    
                    if (systemMaintenance) {
                        window.location.href = 'maintenance.html';
                        return false;
                    }
                }
                return true;
            } catch (error) {
                console.error('Error checking maintenance:', error);
                return true;
            }
        }

        // Check if user has deposit history
        async function checkDepositHistory(uid) {
            try {
                const depositQuery = query(
                    collection(db, 'deposit_requests'),
                    where('uid', '==', uid),
                    where('status', '==', 'approved')
                );
                
                const depositSnap = await getDocs(depositQuery);
                hasDepositHistory = !depositSnap.empty;
                
                return hasDepositHistory;
            } catch (error) {
                console.error('Error checking deposit history:', error);
                return false;
            }
        }

        // Check if user has active products
        async function checkUserProducts(uid) {
            try {
                const userProductsQuery = query(
                    collection(db, 'user_products'),
                    where('uid', '==', uid),
                    where('status', 'in', ['active', 'completed'])
                );
                
                const userProductsSnap = await getDocs(userProductsQuery);
                return !userProductsSnap.empty;
            } catch (error) {
                console.error('Error checking user products:', error);
                return false;
            }
        }

        // Load user data
        async function loadUserData(uid) {
            try {
                const userRef = doc(db, 'users', uid);
                const userSnap = await getDoc(userRef);
                
                if (userSnap.exists()) {
                    userData = userSnap.data();
                    currentBalance = userData.balance || 0;
                    
                    // Check account status
                    if (userData.account_status === 'suspended' || userData.account_status === 'banned') {
                        window.location.href = 'banned.html';
                        return;
                    }
                    
                    // Check if email is verified
                    if (!userData.email_verified) {
                        showToast('Email harus diverifikasi untuk melakukan withdraw', 'warning');
                        submitBtn.disabled = true;
                    }
                    
                    // Update UI
                    balanceAmount.textContent = formatCurrency(currentBalance);
                    
                    // Check deposit history
                    const hasDeposit = await checkDepositHistory(uid);
                    if (!hasDeposit) {
                        // Not showing warning yet, will check on submit
                        console.log('User has no deposit history');
                    }
                    
                    // Check if user has at least 1 product
                    const hasProducts = await checkUserProducts(uid);
                    if (!hasProducts) {
                        showToast('Anda harus memiliki minimal 1 produk aktif untuk melakukan withdraw', 'warning');
                        submitBtn.disabled = true;
                    }
                    
                } else {
                    console.error('User document not found');
                    await signOut(auth);
                    window.location.href = 'login.html';
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                showToast('Gagal memuat data pengguna', 'error');
            }
        }

        // Generate withdraw ID
        function generateWithdrawId() {
            const timestamp = Date.now().toString().slice(-6);
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `WD-${timestamp}${random}`;
        }

        // Final validation before submit
        async function validateBeforeSubmit() {
            if (!currentUser) {
                showToast('Sesi login telah berakhir', 'error');
                window.location.href = 'login.html';
                return false;
            }
            
            // Check deposit history
            const hasDeposit = await checkDepositHistory(currentUser.uid);
            if (!hasDeposit) {
                showToast('Anda harus melakukan deposit minimal 1x sebelum melakukan withdraw. Silakan deposit terlebih dahulu.', 'warning');
                setTimeout(() => {
                    window.location.href = 'deposit.html';
                }, 3000);
                return false;
            }
            
            // Check if user has active products
            const hasProducts = await checkUserProducts(currentUser.uid);
            if (!hasProducts) {
                showToast('Anda harus memiliki minimal 1 produk aktif untuk melakukan withdraw', 'warning');
                return false;
            }
            
            // Check email verification
            if (!userData.email_verified) {
                showToast('Email harus diverifikasi untuk melakukan withdraw', 'warning');
                return false;
            }
            
            return true;
        }

        // Submit withdraw request
        async function submitWithdraw() {
            const amount = parseFloat(amountInput.value);
            const method = methodSelect.value;
            const destination = destinationInput.value.trim();
            const account = accountInput.value.trim();
            
            if (!currentUser) {
                showToast('Sesi login telah berakhir', 'error');
                window.location.href = 'login.html';
                return;
            }
            
            if (amount > currentBalance) {
                showToast('Saldo tidak mencukupi', 'error');
                return;
            }
            
            // Final validation before submit
            const isValid = await validateBeforeSubmit();
            if (!isValid) {
                return;
            }
            
            // Show loading
            loadingSpinner.classList.add('show');
            submitBtn.disabled = true;
            
            try {
                const batch = writeBatch(db);
                const withdrawId = generateWithdrawId();
                const now = Timestamp.now();
                
                // 1. Create withdraw request
                const withdrawRef = doc(db, 'withdraw_requests', withdrawId);
                const withdrawData = {
                    withdraw_id: withdrawId,
                    uid: currentUser.uid,
                    username: userData.username || '',
                    bank_name: method === 'bank' ? destination : '',
                    bank_account_name: userData.full_name || '',
                    bank_account_number: account,
                    amount: amount,
                    admin_fee: 0,
                    net_amount: amount,
                    status: 'pending',
                    admin_note: null,
                    created_at: now,
                    processed_at: null,
                    completed_at: null,
                    processed_by: null
                };
                
                batch.set(withdrawRef, withdrawData);
                
                // 2. Update user balance
                const userRef = doc(db, 'users', currentUser.uid);
                batch.update(userRef, {
                    balance: increment(-amount),
                    locked_balance: increment(amount),
                    total_withdraw: increment(amount),
                    last_activity: now
                });
                
                // 3. Create transaction history
                const historyRef = doc(collection(db, 'history'));
                const historyData = {
                    uid: currentUser.uid,
                    type: 'withdraw',
                    amount: amount,
                    status: 'pending',
                    reference_id: withdrawId,
                    description: `Withdraw ke ${destination} - ${account}`,
                    created_at: now,
                    before_balance: currentBalance,
                    after_balance: currentBalance - amount
                };
                
                batch.set(historyRef, historyData);
                
                // 4. Create notification for user
                const notificationRef = doc(collection(db, 'notifications'));
                const notificationData = {
                    uid: currentUser.uid,
                    type: 'withdraw_submitted',
                    title: 'Withdraw Diajukan',
                    message: `Withdraw sebesar Rp ${amount.toLocaleString('id-ID')} berhasil diajukan. Menunggu konfirmasi admin.`,
                    read: false,
                    created_at: now
                };
                
                batch.set(notificationRef, notificationData);
                
                // Commit batch
                await batch.commit();
                
                // Update local balance
                currentBalance -= amount;
                balanceAmount.textContent = formatCurrency(currentBalance);
                
                // Reset form
                amountInput.value = '';
                methodSelect.value = '';
                destinationInput.value = '';
                accountInput.value = '';
                
                // Reset quick amount buttons
                amountButtons.forEach(btn => btn.classList.remove('active'));
                
                // Show success message
                showToast(`Withdraw Rp ${amount.toLocaleString('id-ID')} berhasil diajukan! Akan diproses dalam 1-24 jam kerja.`, 'success');
                
                // Log success
                console.log('Withdraw submitted successfully:', withdrawId);
                
            } catch (error) {
                console.error('Error submitting withdraw:', error);
                showToast('Gagal mengajukan withdraw. Silakan coba lagi.', 'error');
            } finally {
                loadingSpinner.classList.remove('show');
                updateFormValidation();
            }
        }

        // Event Listeners
        function initEventListeners() {
            // Amount input validation
            amountInput.addEventListener('input', () => {
                updateFormValidation();
            });
            
            // Method select change
            methodSelect.addEventListener('change', () => {
                const method = methodSelect.value;
                
                if (method === 'bank') {
                    destinationLabel.textContent = 'Nama Bank';
                    destinationInput.placeholder = 'Contoh: BCA, BRI, Mandiri';
                    accountLabel.textContent = 'Nomor Rekening';
                    accountInput.placeholder = 'Contoh: 1234567890';
                } else if (method === 'ewallet') {
                    destinationLabel.textContent = 'Nama E-Wallet';
                    destinationInput.placeholder = 'Contoh: GoPay, OVO, DANA';
                    accountLabel.textContent = 'Nomor Akun';
                    accountInput.placeholder = 'Contoh: 081234567890';
                }
                
                updateFormValidation();
            });
            
            // Destination input validation
            destinationInput.addEventListener('input', () => {
                updateFormValidation();
            });
            
            // Account input validation
            accountInput.addEventListener('input', () => {
                updateFormValidation();
            });
            
            // Quick amount buttons
            amountButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const amount = parseInt(button.getAttribute('data-amount'));
                    amountInput.value = amount;
                    
                    // Update button states
                    amountButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    updateFormValidation();
                });
            });
            
            // Submit button
            submitBtn.addEventListener('click', submitWithdraw);
            
            // Input keyboard shortcuts
            amountInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (!submitBtn.disabled) {
                        submitWithdraw();
                    }
                }
            });
        }

        // Initialize the page
        async function initPage() {
            // Initialize stars background
            initStars();
            
            // Check maintenance
            const maintenanceOk = await checkMaintenance();
            if (!maintenanceOk) return;
            
            // Check authentication
            onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    // Not logged in, redirect to login
                    window.location.href = 'login.html';
                    return;
                }
                
                currentUser = user;
                await loadUserData(user.uid);
                initEventListeners();
            }, (error) => {
                console.error('Auth state change error:', error);
                showToast('Error sistem autentikasi', 'error');
            });
        }

        // Start the application
        initPage();
    </script>
</body>
</html>